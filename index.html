<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panelto Bakery</title>
<style>
  :root{
    --bg:#f7fafc;
    --ink:#1e293b;
    --muted:#64748b;
    --card:#ffffff;
    --brand:#2563eb;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%;margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;
    background:var(--bg);color:var(--ink)
  }
  header{
    position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e2e8f0;
  }
  .hwrap{max-width:960px;margin:0 auto;padding:12px 14px;display:flex;align-items:center;gap:10px}
  .title{font-weight:800}
  main{max-width:960px;margin:0 auto;padding:12px}

  .stack{display:flex;flex-direction:column;gap:10px}
  .tile{
    display:block;background:linear-gradient(135deg,#fff,#f8fafc);
    border:1px solid #e2e8f0;border-radius:14px;
    box-shadow:0 4px 14px rgba(0,0,0,.08);
    padding:18px 16px;text-decoration:none;color:inherit
  }
  .tile h2{margin:0 0 4px 0;font-size:1.1rem}
  .tile p{margin:0;color:var(--muted);font-size:.9rem}
  .tile:active{transform:translateY(1px)}

    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .square{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center}
  .c1{background:#fef3c7}
  .c2{background:#dbeafe}
  .c3{background:#d1fae5}
  .c4{background:#f3e8ff}

  .card{background:var(--card);border:1px solid #e2e8f0;border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.08);padding:12px}
  .crumbs{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0 12px}
  .crumbs a{color:var(--brand);text-decoration:none}
  .crumbs .sep{opacity:.45;color:var(--muted)}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
  input[type="search"],select{padding:8px 10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:var(--ink)}
  .btn{background:var(--brand);border:none;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--ink);border:1px solid #cbd5e1}
  .small{font-size:.86rem;color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{display:flex;align-items:center;gap:12px;border:1px solid #e2e8f0;border-radius:12px;padding:12px;background:#fff}
  .item a.title{flex:1;text-decoration:none;color:inherit}
  .item a.title:hover{text-decoration:underline}
  .item .meta{font-size:.82rem;color:var(--muted);margin-top:4px}
  .icon-btn{min-width:34px;min-height:34px;border-radius:999px;border:1px solid #cbd5e1;background:#2563eb;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .icon-btn svg{width:16px;height:16px;display:block}
  footer{height:1px}

  .works-table{display:flex;flex-direction:column;gap:12px}
  .works-table__controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between}
  .works-table__search{flex:1;min-width:220px}
  .works-table__search input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:var(--ink);box-shadow:0 1px 2px rgba(15,23,42,.04)}
  .works-table__actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .works-table__notice{font-size:.82rem;color:var(--muted)}
  .works-table__scroll{max-height:70vh;overflow:auto;border-radius:12px;border:1px solid #e2e8f0;background:#fff;box-shadow:0 12px 30px rgba(15,23,42,.08)}
  .works-table__table{width:100%;border-collapse:separate;border-spacing:0;font-size:.95rem;color:var(--ink);font-variant-numeric:tabular-nums}
  .works-table__table thead th{position:sticky;top:0;background:#f1f5f9;padding:12px 14px;border-bottom:1px solid #dbeafe;font-weight:600;text-align:left;cursor:pointer;transition:background .2s,color .2s}
  .works-table__table th,.works-table__table td{padding:12px 14px;border-bottom:1px solid #eef2f7;vertical-align:top;word-break:break-word;min-width:120px}
  .works-table__table tbody tr:nth-child(even){background:#f8fafc}
  .works-table__table tbody tr:hover{background:#eef2ff}
  .works-table__table td.is-sorted{background:rgba(37,99,235,.08)}
  .works-table__table th.is-sorted{color:var(--brand);background:#e2e8ff}
  .sort-indicator{margin-left:6px;font-size:.75rem;opacity:.6}
  .works-table__empty{padding:24px;text-align:center;color:var(--muted)}
  .works-table__meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;font-size:.82rem;color:var(--muted)}
</style>
</head>
<body>
  <!-- Header + Global search -->
  <header>
    <div class="hwrap">
      <div class="title">Panelto Bakery</div>
      <form id="globalSearchForm" style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <input id="globalSearchInput" type="search" placeholder="Search all files…" aria-label="Search" style="padding:8px 10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:#1e293b;min-width:210px">
        <button class="btn" type="submit">Search</button>
        <button class="btn ghost" id="clearSearchBtn" type="button" style="display:none">Clear</button>
      </form>
    </div>
  </header>

  <!-- PIN lock -->
  <div id="lockscreen" style="position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f7fafc;z-index:9999;">
    <h2 style="margin-bottom:12px;font-family:Inter,sans-serif;color:#1e293b;">Enter Access Code</h2>
    <input type="password" id="pinInput" placeholder="Code" style="padding:10px 14px;border:1px solid #cbd5e1;background:#fff;color:#1e293b;border-radius:8px;font-size:1rem;">
    <button id="pinBtn" style="margin-top:12px;padding:10px 16px;border:none;border-radius:8px;background:#2563eb;color:#fff;font-size:1rem;cursor:pointer;">Unlock</button>
    <p id="pinMsg" style="color:#dc2626;margin-top:10px;display:none;">Wrong code</p>
  </div>

  <!-- PREVIEW MODAL -->
  <div id="previewBackdrop" style="position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;z-index:9998;">
@@ -156,52 +174,56 @@
      'Freezer':      {documentation:'1C4mCKM1DkXJwD-gVMf4spO8REjc6LDTC', works:'1vnbdMMISy38_SiJpVOuVoyC0UUEDaZaV', electrical:'1xqcwh5GvmZgSkCyffzQNINw4P_91W4Df', procedures:'1X14Fgcb8rESKIGQNXVo1bVT9cYn_f4s6'},
      'Cooler':       {documentation:'1tEemK1qcOlAn55CLOCWyUgS4PdASNbQ5', works:'1CUMUsoIRNl0PO8mQoK0-EmgHxMFuZLXI', electrical:'1dHbBL4-iVcekRBlTIr7jdUz17kL8MZUj', procedures:'1fcL8I_FZqD_JEmiuerWKyGN_8TJo09hU'},
      'Baggers':      {documentation:'1llq6U95hQc3NcGg1JDqOBKbmxJxsYcUR', works:'1HrGgPLFF4sUmc2FXsBlr_KNgdiEmnyUJ', electrical:'1J1W8STCRjfGfv4q91ZyxkyKiEUev_cAA', procedures:'1GewCaKsiOLEukax4ZIZTSP42k-WFR280'},
      'AHU':          {documentation:'1QMKYSOQ-N0LVANk8MZNiB07DTKI-QC7U', works:'1tSXor0e_YtcabRFabUO_AOhEMjzTttuh', electrical:'1m3CYpvbWyqJBX022oiOwJNcBayqOFF1a', procedures:'1PcPbWgBbTDnPZAidlPI-_T4-fpJP2q0o'}
    },
    'Bakery 3': {
      'Site 1 Packing': {documentation:'1J210oJpvaS2VhXOMaQm8oXAFbCW8FDa7', works:'1emCk6hQQF25eMn8D7LyJD4uyqt4vFfQW', electrical:'1mG4EyGxk4Be4nbV_WW316FqzuTl1QCR-', procedures:'1DJwbexql1dakzKXYDvofvFam9vTuikS'},
      'Site 2 Packing': {documentation:'1OovqnA9jsAdFJSxeeWj9Dr9K4VUya5yi', works:'15C_uMSqzoJjdSpBfE6xVpBEbiWeBgZn-', electrical:'17pLXNKAOomUOwo642WazWVboOwJiZPCl', procedures:'1u1Ipt5v375gwd8CufIkc3TckKTQA-dKE'},
      'Paletiser':      {documentation:'1exaNF6HaJVw4D8ODVdDDiurYhxGzmn-8', works:'1Nd3vqzlvIw2reDo2ELeCw5q_UC5YRR8y', electrical:'1r8lSFtNAwSoMpPSVouj7Jv39WeL5xmXw', procedures:'1CNgEId5CKxNlMcwmZxJsIG0DQB266s5Y'},
      'Retail':         {documentation:'1tghnGJ1e09FnOwhTV1UKZpSl-XRT62On', works:'1hoUvzxjpA6z2TTggwiSj-7CMfkQ40rCB', electrical:'1QIkmIstBW4RKryafamYp38Jnr3DLLtlm', procedures:'1soZAoyN9pp4xTkKcQczMH37Yqx8t48EA'}
    }
  };

  // Category metadata
  const CATS = {
    documentation: { title:'Documentation',   color:'c1', desc:'User manuals & technical docs' },
    works:         { title:'Work History',     color:'c2', desc:'Repairs, interventions' },
    electrical:    { title:'Electrical Diagrams', color:'c3', desc:'Wiring & schematics' },
    procedures:    { title:'Procedures',       color:'c4', desc:'SOPs & guides' }
  };

  /* === OPTIONAL: Work History preko Google Sheets ===
     For machines where you want a tabular sheet instead of Drive listing, set sheetId and sheetName. */
  const WORKS_SHEETS = {
    'Bakery 1': {
      // Uses the sheet Petar shared (ID extracted from the URL) – sheet tab "Work History without routines"
      'Fritsch': {
        sheetId: '1j3KX2qGjFj9tOHWZLKY_xJMV70wBr5KQfZab0-TYw0k',
        sheetName: 'Work History without routines',
        gid: '1835750486'
      }
    },
    'Bakery 2': {},
    'Bakery 3': {}
  };

  /* ===== Utilities ===== */
  function params(){ return new URLSearchParams(location.search); }
  function go(obj){ const u=new URL(location.href); u.search=new URLSearchParams(obj).toString(); history.pushState({},'',u); draw(); }
  window.addEventListener('popstate', draw);

  function crumbsSet(items){
    const el = document.getElementById('crumbs');
    el.innerHTML='';
    items.forEach((it,i)=>{
      const a=document.createElement('a');
      a.href='javascript:void(0)';
      a.textContent=it.label;
      a.onclick=()=>{ go(it.to||{}); };
      el.appendChild(a);
      if(i<items.length-1){
        const s=document.createElement('span');
        s.className='sep'; s.textContent='›'; el.appendChild(s);
      }
    });
  }
@@ -324,152 +346,380 @@
    await gapi.client.init({apiKey:API_KEY,discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']});
    gapiReady=true;
  }
  async function ensureAuth(){
    if(accessToken) return accessToken;
    await ensureGapi();
    return new Promise((res,rej)=>{
      const c=google.accounts.oauth2.initTokenClient({
        client_id:CLIENT_ID,
        scope:SCOPES,
        callback:r=>{ if(r&&r.access_token){accessToken=r.access_token;res(accessToken);} else rej(new Error('No token')); }
      });
      c.requestAccessToken({prompt:'consent'});
    });
  }
  function folderIdFor(b,m,cat){ return FOLDERS?.[b]?.[m]?.[cat] || null; }

  /* ===== WORK HISTORY VIEWER (Google Sheets) ===== */
  // Fetch as GViz JSON (preferred) or CSV fallback
  async function fetchSheetTable(sheetId, sheetName, gid){
    if(sheetName){
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
      const res = await fetch(url);
      if(res.ok){
        const text = await res.text();
        const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
        const data = JSON.parse(jsonText);
        const tableData = data.table || {};
        let rows = (tableData.rows||[]).map(r => (r.c||[]).map(c => (c ? (c.f ?? c.v ?? '') : '')));
        const firstRow = rows[0] || [];
        let usedFirstRowForHeaders = false;
        let headers = (tableData.cols||[]).map((col, idx) => {
          const rawLabel = (col.label ?? '').toString().trim();
          if(rawLabel){ return rawLabel; }
          const fallback = firstRow[idx] != null ? String(firstRow[idx]).trim() : '';
          if(fallback){ usedFirstRowForHeaders = true; return fallback; }
          return `Column ${idx+1}`;
        });
        if(usedFirstRowForHeaders && firstRow.length){
          const matches = headers.every((h, idx) => {
            const val = firstRow[idx] != null ? String(firstRow[idx]).trim() : '';
            return val && val === h;
          });
          if(matches){ rows = rows.slice(1); }
        }
        headers = headers.map((h, idx) => (h && h.trim()) ? h.trim() : `Column ${idx+1}`);
        return { headers, rows };
      }
      if(!gid) throw new Error('Sheet fetch failed '+res.status);
    }
    if(gid){
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&id=${sheetId}&gid=${gid}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('CSV fetch failed '+res.status);
      const text = await res.text();
      const rows = [];
      let row = [], inQuotes = false, field = '';
      for (let i=0; i<text.length; i++){
        const ch = text[i], next = text[i+1];
        if (inQuotes){
          if (ch === '"' && next === '"'){ field += '"'; i++; }
          else if (ch === '"'){ inQuotes = false; }
          else { field += ch; }
        } else {
          if (ch === '"'){ inQuotes = true; }
          else if (ch === ','){ row.push(field); field=''; }
          else if (ch === '\n'){ row.push(field); rows.push(row); row=[]; field=''; }
          else if (ch === '\r'){ /* ignore */ }
          else { field += ch; }
        }
      }
      if (field.length || row.length) { row.push(field); rows.push(row); }
      const headers = (rows.shift() || []).map(v => (v ?? '').toString().trim());
      return { headers, rows };
    }
    throw new Error('No sheetName or gid configured.');
  }

  function renderWorksTable(container, table, options={}){
    container.innerHTML = '';

    const root = document.createElement('div'); root.className='works-table';
    container.appendChild(root);

    const controls = document.createElement('div'); controls.className='works-table__controls'; root.appendChild(controls);

    const searchWrap = document.createElement('div'); searchWrap.className='works-table__search'; controls.appendChild(searchWrap);
    const searchInput = document.createElement('input'); searchInput.type='search'; searchInput.placeholder='Search records…'; searchWrap.appendChild(searchInput);

    const actions = document.createElement('div'); actions.className='works-table__actions'; controls.appendChild(actions);

    const adminSignInBtn = document.createElement('button'); adminSignInBtn.type='button'; adminSignInBtn.className='btn'; adminSignInBtn.textContent='Admin: Sign in'; actions.appendChild(adminSignInBtn);
    const adminSignOutBtn = document.createElement('button'); adminSignOutBtn.type='button'; adminSignOutBtn.className='btn ghost'; adminSignOutBtn.textContent='Admin: Sign out'; actions.appendChild(adminSignOutBtn);
    const csvBtn = document.createElement('button'); csvBtn.type='button'; csvBtn.className='btn ghost'; csvBtn.textContent='Download CSV'; actions.appendChild(csvBtn);
    const openSheetBtn = document.createElement('button'); openSheetBtn.type='button'; openSheetBtn.className='btn ghost'; openSheetBtn.textContent='Open sheet (Admin)'; actions.appendChild(openSheetBtn);

    const notice = document.createElement('div'); notice.className='works-table__notice'; root.appendChild(notice);

    const scroll = document.createElement('div'); scroll.className='works-table__scroll'; root.appendChild(scroll);
    const tableEl = document.createElement('table'); tableEl.className='works-table__table'; scroll.appendChild(tableEl);

    const thead = document.createElement('thead'); const headerRow = document.createElement('tr'); thead.appendChild(headerRow); tableEl.appendChild(thead);
    const tbody = document.createElement('tbody'); tableEl.appendChild(tbody);

    const indicators = [];
    const headers = table.headers.length ? table.headers : table.rows[0]?.map((_, idx) => `Column ${idx+1}`) || [];
    headers.forEach((label, idx) => {
      const th = document.createElement('th'); th.tabIndex = 0; th.setAttribute('aria-sort','none');
      const titleSpan = document.createElement('span'); titleSpan.textContent = label || `Column ${idx+1}`;
      const indicator = document.createElement('span'); indicator.className='sort-indicator'; indicator.textContent='';
      th.append(titleSpan, indicator);
      th.addEventListener('click', () => sortBy(idx));
      th.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter' || ev.key===' '){ ev.preventDefault(); sortBy(idx); } });
      headerRow.appendChild(th);
      indicators[idx] = { th, indicator };
    });

    const meta = document.createElement('div'); meta.className='works-table__meta'; root.appendChild(meta);

    let currentRows = table.rows.slice();
    const totalRows = currentRows.length;
    const columnTypes = inferColumnTypes(headers, table.rows);
    let sortCol = -1;
    let sortDir = 'desc';
    let isAdmin = !!options.isAdmin;

    function updateAdminUI(){
      if(isAdmin){
        notice.textContent = 'Admin tools unlocked — you can download CSV or open the sheet for editing.';
        adminSignInBtn.style.display='none';
        adminSignOutBtn.style.display='';
        csvBtn.style.display='';
        openSheetBtn.style.display='';
      } else {
        notice.textContent = 'Sign in with your admin Google account to download CSV or edit the sheet.';
        adminSignInBtn.style.display='';
        adminSignOutBtn.style.display='none';
        csvBtn.style.display='none';
        openSheetBtn.style.display='none';
      }
    }

    function setAdminState(next){
      isAdmin = !!next;
      updateAdminUI();
      if(typeof options.onAdminStateChange === 'function'){ options.onAdminStateChange(isAdmin); }
    }

    function formatCount(){
      if(!totalRows){ return 'No records available.'; }
      if(currentRows.length === totalRows){ return `Showing all ${totalRows} records.`; }
      return `Showing ${currentRows.length} of ${totalRows} records.`;
    }

    function parseNumberValue(val){
      if(val==null || val===''){ return null; }
      if(typeof val === 'number' && Number.isFinite(val)){ return val; }
      const str = String(val).trim(); if(!str){ return null; }
      const normalized = str.replace(/\s+/g,'').replace(/,(?=\d{3}(?:[^\d]|$))/g,'').replace(',','.');
      if(!/^[-+]?\d*(?:\.\d+)?$/.test(normalized)){ return null; }
      const num = Number(normalized); return Number.isFinite(num) ? num : null;
    }

    function parseDateValue(val){
      if(!val && val!==0){ return null; }
      if(val instanceof Date && !isNaN(val)){ return val.getTime(); }
      const str = String(val).trim(); if(!str){ return null; }
      const direct = Date.parse(str);
      if(!Number.isNaN(direct)){ return direct; }
      const m = str.match(/^(\d{1,2})[\.\/-](\d{1,2})[\.\/-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
      if(m){
        const day = parseInt(m[1],10);
        const month = parseInt(m[2],10)-1;
        let year = parseInt(m[3],10);
        if(year < 100){ year += year >= 70 ? 1900 : 2000; }
        const hour = m[4] ? parseInt(m[4],10) : 0;
        const minute = m[5] ? parseInt(m[5],10) : 0;
        const second = m[6] ? parseInt(m[6],10) : 0;
        const date = new Date(year, month, day, hour, minute, second);
        if(date.getFullYear()===year && date.getMonth()===month && date.getDate()===day){
          return date.getTime();
        }
      }
      return null;
    }

    function inferColumnTypes(headersList, rowsList){
      return headersList.map((header, idx) => {
        const headerLower = (header||'').toLowerCase();
        if(headerLower.includes('date')){ return 'date'; }
        let dateHits = 0, numberHits = 0;
        for(let i=0;i<rowsList.length;i++){
          const cell = rowsList[i]?.[idx];
          if(cell==null || cell===''){ continue; }
          if(parseDateValue(cell)!=null){ dateHits++; continue; }
          if(parseNumberValue(cell)!=null){ numberHits++; }
        }
        if(dateHits && dateHits >= numberHits){ return 'date'; }
        if(numberHits){ return 'number'; }
        return 'text';
      });
    }

    function getSortableValue(value, type){
      if(value==null || value===''){ return null; }
      if(type==='number'){
        const num = parseNumberValue(value);
        if(num!=null){ return num; }
        const dateAlt = parseDateValue(value);
        if(dateAlt!=null){ return dateAlt; }
      }
      if(type==='date'){
        const ts = parseDateValue(value);
        if(ts!=null){ return ts; }
        const numeric = parseNumberValue(value);
        if(numeric!=null){ return numeric; }
      }
      return String(value).toLowerCase();
    }

    function compareValues(a,b,type){
      if(a===b){ return 0; }
      if(a==null){ return 1; }
      if(b==null){ return -1; }
      if(type==='text'){ return String(a).localeCompare(String(b)); }
      return a < b ? -1 : 1;
    }

    function updateMeta(){ meta.textContent = formatCount(); }

    function renderBody(){
      tbody.innerHTML='';
      if(!currentRows.length){
        const tr = document.createElement('tr');
        const td = document.createElement('td'); td.colSpan = headers.length || 1; td.className='works-table__empty'; td.textContent='No matching records.';
        tr.appendChild(td); tbody.appendChild(tr);
      } else {
        currentRows.forEach(row => {
          const tr = document.createElement('tr');
          row.forEach((cell, idx) => {
            const td = document.createElement('td');
            const value = cell==null ? '' : String(cell);
            if(idx === sortCol){ td.classList.add('is-sorted'); }
            td.textContent = value;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }
      updateMeta();
    }

    function applySort(){
      if(sortCol < 0){ return; }
      const type = columnTypes[sortCol] || 'text';
      currentRows.sort((a,b) => {
        const av = getSortableValue(a?.[sortCol], type);
        const bv = getSortableValue(b?.[sortCol], type);
        const cmp = compareValues(av,bv,type);
        return sortDir === 'asc' ? cmp : -cmp;
      });
    }

    function updateSortIndicators(){
      indicators.forEach((entry, idx) => {
        const { th, indicator } = entry;
        if(sortCol === idx){
          th.classList.add('is-sorted');
          th.setAttribute('aria-sort', sortDir === 'asc' ? 'ascending' : 'descending');
          indicator.textContent = sortDir === 'asc' ? '▲' : '▼';
        } else {
          th.classList.remove('is-sorted');
          th.setAttribute('aria-sort','none');
          indicator.textContent='';
        }
      });
    }

    function applyFilters(){
      const term = (searchInput.value||'').trim().toLowerCase();
      currentRows = table.rows.filter(row => {
        if(!term){ return true; }
        return row.some(cell => String(cell??'').toLowerCase().includes(term));
      });
      applySort();
      renderBody();
      updateSortIndicators();
    }

    function sortBy(colIdx){
      if(sortCol === colIdx){
        sortDir = sortDir === 'asc' ? 'desc' : 'asc';
      } else {
        sortCol = colIdx;
        sortDir = columnTypes[colIdx] === 'date' ? 'desc' : 'asc';
      }
      applyFilters();
    }

    searchInput.addEventListener('input', () => { applyFilters(); });

    csvBtn.addEventListener('click', () => {
      if(!isAdmin){ return; }
      const esc = (s)=>('"'+String(s??'').replace(/"/g,'""')+'"');
      const lines = [ headers.map(esc).join(','), ...currentRows.map(row=>row.map(esc).join(',')) ].join('\r\n');
      const blob = new Blob([lines], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='work_history.csv'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 5000);
    });

    openSheetBtn.addEventListener('click', () => {
      if(!isAdmin){ alert('Please sign in as admin first.'); return; }
      const entry = options.sheetEntry || {};
      let url = `https://docs.google.com/spreadsheets/d/${entry.sheetId}/edit`;
      if(entry.gid){ url += `#gid=${entry.gid}`; }
      window.open(url, '_blank', 'noopener');
    });

    adminSignInBtn.addEventListener('click', async () => {
      if(typeof options.requestAdminSignIn !== 'function'){ return; }
      try{
        adminSignInBtn.disabled = true; adminSignInBtn.textContent = 'Signing in…';
        await options.requestAdminSignIn();
        setAdminState(true);
      }catch(e){
        alert('Admin sign-in failed: '+(e.message||String(e)));
      }finally{
        adminSignInBtn.disabled = false; adminSignInBtn.textContent = 'Admin: Sign in';
      }
    });

    adminSignOutBtn.addEventListener('click', () => {
      if(typeof options.signOutAdmin === 'function'){ options.signOutAdmin(); }
      setAdminState(false);
    });

    updateAdminUI();
    applyFilters();
  }

  async function drawWorksSheetView(bakery, machine, container){
    const entry = WORKS_SHEETS?.[bakery]?.[machine];
    if(!entry || !entry.sheetId){
      container.innerHTML = '<div class="small">No Google Sheet configured for this machine. Showing Drive folder instead.</div>';
      return null; // continue with Drive listing
    }
    try{
      container.innerHTML = '<div class="small">Loading Work History…</div>';
      const table = await fetchSheetTable(entry.sheetId, entry.sheetName||'Sheet1', entry.gid);
      renderWorksTable(container, table, {
        isAdmin: isAdminSignedIn(),
        sheetEntry: entry,
        requestAdminSignIn: async () => { await ensureAuth(); },
        signOutAdmin: () => { accessToken = null; }
      });
      return true;
    }catch(e){
      container.innerHTML = `<div class="small">Failed to load Work History: ${escapeHtml(e.message||String(e))}</div>`;
      return true; // don't render Drive listing on error to avoid confusion
    }
  }

  /* ===== Category view ===== */
  function drawCategory(b,m,catKey){
    const cat=CATS[catKey];
    if(!cat){ go({bakery:b,machine:m}); return; }

    crumbsSet([
      {label:'Home',to:{}},
      {label:b,to:{bakery:b}},
      {label:m,to:{bakery:b,machine:m}},
      {label:cat.title,to:{bakery:b,machine:m,cat:catKey}}
    ]);

    const view=document.getElementById('view');
    view.innerHTML='';

    const card=document.createElement('div'); card.className='card';
    const h=document.createElement('h3'); h.textContent=`${b} › ${m} › ${cat.title}`; card.appendChild(h);

@@ -478,51 +728,52 @@
    function refreshHint(){
      if(!fid){ hint.style.display = ''; hint.innerHTML = '⚠️ Set Drive folder ID in <code>FOLDERS</code>.'; }
      else if (accessToken) { hint.style.display = ''; hint.innerHTML = `Folder ID: <code>${escapeHtml(fid)}</code>`; }
      else { hint.style.display = 'none'; hint.innerHTML = ''; }
    }
    refreshHint();

    const bar=document.createElement('div'); bar.className='toolbar';
    const search=document.createElement('input'); search.type='search'; search.placeholder='Search files';
    const file=document.createElement('input'); file.type='file'; file.accept='application/pdf,image/*';
    const up=document.createElement('button'); up.className='btn'; up.textContent='Upload';
    const refresh=document.createElement('button'); refresh.className='btn ghost'; refresh.textContent='Refresh';
    const adminBtn=document.createElement('button'); adminBtn.className='btn ghost'; adminBtn.textContent='Admin: Sign in';
    bar.append(adminBtn,search,file,up,refresh); card.appendChild(bar);

    const list=document.createElement('div'); list.className='list'; card.appendChild(list);
    view.appendChild(card);

    // Hide upload controls in public mode
    file.style.display='none'; up.style.display='none';

    // If Work History and Sheet configured, render the table and exit early
    if (catKey === 'works') {
      const sheetEntry = WORKS_SHEETS?.[b]?.[m];
      if (sheetEntry && sheetEntry.sheetId) {
        bar.style.display = 'none';
        file.style.display = 'none'; up.style.display = 'none'; refresh.style.display = 'none'; adminBtn.style.display = 'none'; search.style.display='none';
        drawWorksSheetView(b, m, list).catch(e => { list.innerHTML = `<div class="small">Failed to load Work History: ${escapeHtml(e.message||String(e))}</div>`; });
        return; // do not render Drive listing when Sheet view is used
      }
    }

    /* PUBLIC list */
    async function publicListFiles(){
      list.innerHTML='<div class="small">Loading…</div>';
      try{
        if(!fid){ list.innerHTML='<div class="small">Set Drive folder ID.</div>'; return; }
        const params=new URLSearchParams({
          q:`'${fid}' in parents and trashed=false`,
          fields:'files(id,name,modifiedTime,mimeType,webViewLink)',
          orderBy:'modifiedTime desc', pageSize:'100', key:API_KEY,
          supportsAllDrives:'true', includeItemsFromAllDrives:'true'
        });
        const res=await fetch('https://www.googleapis.com/drive/v3/files?'+params.toString());
        if(!res.ok){ const j=await res.json().catch(()=>({})); throw new Error(j.error?.message||('HTTP '+res.status)); }
        const data=await res.json();
        let items=data.files||[];
        const s=(search.value||'').toLowerCase(); if(s) items=items.filter(f=>(f.name||'').toLowerCase().includes(s));
        if(!items.length){ list.innerHTML='<div class="small">No files yet.</div>'; return; }
        list.innerHTML='';
        items.forEach(f=>{
          const row=document.createElement('div'); row.className='item';
          const title=document.createElement('a'); title.className='title'; title.href='#';
          title.onclick=(e)=>{ e.preventDefault(); openInlinePreview(f,false); };
          const when=f.modifiedTime?new Date(f.modifiedTime).toLocaleString():'';
          title.innerHTML=`<div><strong>${escapeHtml(f.name)}</strong><div class="meta">${escapeHtml(f.mimeType||'')} • ${escapeHtml(when)}</div></div>`;
          const dl=document.createElement('a'); dl.className='icon-btn'; dl.href=publicDownloadUrl(f.id); dl.target='_blank'; dl.rel='noopener';
          dl.innerHTML=`<svg viewBox="0 0 24 24" fill="none"><path d="M12 3v10m0 0 4-4m-4 4-4-4M4 20h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
          row.append(title,dl); list.appendChild(row);
        });
      }catch(e){ list.innerHTML=`<div class="small">Public list error: ${escapeHtml(e.message||String(e))}</div>`; }
    }

    /* PRIVATE list (admin) */
    async function privateListFiles(){
      list.innerHTML='<div class="small">Loading…</div>';
      try{
        if(!fid){ list.innerHTML='<div class="small">Set Drive folder ID.</div>'; return; }
        const q=`'${fid}' in parents and trashed=false`;
        const res=await gapi.client.drive.files.list({ q, fields:'files(id,name,modifiedTime,mimeType,webViewLink)', orderBy:'modifiedTime desc', pageSize:100, supportsAllDrives:true, includeItemsFromAllDrives:true });
        let items=res.result.files||[];
        const s=(search.value||'').toLowerCase(); if(s) items=items.filter(f=>(f.name||'').toLowerCase().includes(s));
        if(!items.length){ list.innerHTML='<div class="small">No files yet.</div>'; return; }
        list.innerHTML='';
        items.forEach(f=>{
          const row=document.createElement('div'); row.className='item';
          const title=document.createElement('a'); title.className='title'; title.href='#'; title.onclick=(e)=>{ e.preventDefault(); openInlinePreview(f,true); };
          const when=f.modifiedTime?new Date(f.modifiedTime).toLocaleString():'';
          title.innerHTML=`<div><strong>${escapeHtml(f.name)}</strong><div class="meta">${escapeHtml(f.mimeType||'')} • ${escapeHtml(when)}</div></div>`;
          const right=document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
          const dl=document.createElement('a'); dl.className='icon-btn'; dl.href=`https://www.googleapis.com/drive/v3/files/${f.id}?alt=media`; dl.target='_blank'; dl.rel='noopener';
          dl.innerHTML=`<svg viewBox="0 0 24 24" fill="none"><path d="M12 3v10m0 0 4-4m-4 4-4-4M4 20h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
          const del=document.createElement('button'); del.className='icon-btn';
          del.innerHTML=`<svg viewBox="0 0 24 24" fill="none"><path d="M6 7h12M10 7v12m4-12v12M9 7l1-2h4l1 2M6 7l1 14h10l1-14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
          del.onclick=async()=>{ if(!confirm('Delete file?')) return; try{ await gapi.client.drive.files.delete({fileId:f.id}); privateListFiles(); } catch(e){ alert('Delete failed: '+(e.result?.error?.message||e.message)); } };
          right.append(dl, del); row.append(title, right); list.appendChild(row);
        });
      }catch(e){ list.innerHTML=`<div class='small'>Error: ${escapeHtml(e.message||String(e))}</div>`; }
    }

    // init (public by default)
    publicListFiles();
    refresh.onclick = publicListFiles;
    search.oninput = publicListFiles;

    // Admin sign-in
    adminBtn.onclick = async () => {
      try{
        await ensureAuth();
        refreshHint(); file.style.display=''; up.style.display='';
        refresh.onclick = privateListFiles; search.oninput = privateListFiles; adminBtn.style.display='none';
        await privateListFiles();
        // sign out button
        const signOut = document.createElement('button'); signOut.className='btn ghost'; signOut.textContent='Admin: Sign out';
        signOut.onclick = ()=>{ accessToken=null; alert('Signed out. Refresh to return to public mode.'); };
        bar.append(signOut);
      }catch(e){ alert('Sign-in failed: ' + (e.message || String(e))); }
    };

    // Upload flow
    up.onclick=async()=>{
      try{
        if(!fid){ alert('Set Drive folder ID in FOLDERS.'); return; }
        if(!file.files || !file.files[0]){ alert('Choose a file'); return; }
        await ensureAuth();
        up.disabled=true; up.textContent='Uploading…';
        const newId = await uploadToDrive(fid, file.files[0]);
        // make it public (read) so operators can scan QR without login
        await gapi.client.drive.permissions.create({ fileId: newId, resource: { type: 'anyone', role: 'reader' } });
        file.value=''; setTimeout(()=>privateListFiles().catch(console.error),300);
      }catch(e){ alert('Upload failed: '+(e.message||String(e))); }
      finally{ up.disabled=false; up.textContent='Upload'; }
    };
  }

  /* ===== GLOBAL SEARCH across mapped folders ===== */
  function buildFolderIndex(){
    const out=[];
    for(const bakery of Object.keys(FOLDERS||{})){
      const machinesObj = FOLDERS[bakery] || {};
      for(const machine of Object.keys(machinesObj)){
        const cats = machinesObj[machine] || {};
        for(const catKey of Object.keys(cats)){
          const folderId = cats[catKey]; if(folderId){ out.push({ bakery, machine, cat:catKey, folderId }); }
        }
      }
    }
    return out;
  }
  const FOLDER_INDEX = buildFolderIndex();
  function isAdminSignedIn(){ return !!accessToken; }
  function escapeQueryForDrive(name){ return (name||'').replace(/'/g, "\\'"); }

  async function searchFolderPublic(folderId, query){
    const q = `'${folderId}' in parents and trashed=false and name contains '${escapeQueryForDrive(query)}'`;
    const params = new URLSearchParams({ q, fields:'files(id,name,modifiedTime,mimeType,webViewLink,parents)', orderBy:'modifiedTime desc', pageSize:'50', key:API_KEY, supportsAllDrives:'true', includeItemsFromAllDrives:'true' });
    const res = await fetch('https://www.googleapis.com/drive/v3/files?'+params.toString());
    if(!res.ok){ const j=await res.json().catch(()=>({})); throw new Error(j.error?.message||('HTTP '+res.status)); }
    const data = await res.json(); return data.files || [];
  }
  async function searchFolderPrivate(folderId, query){
    const q = `'${folderId}' in parents and trashed=false and name contains '${escapeQueryForDrive(query)}'`;
    const res = await gapi.client.drive.files.list({ q, fields:'files(id,name,modifiedTime,mimeType,webViewLink,parents)', orderBy:'modifiedTime desc', pageSize:50, supportsAllDrives:true, includeItemsFromAllDrives:true });
    return res.result.files || [];
  }

  function renderSearchResultsHeader(query){
    const view=document.getElementById('view'); view.innerHTML='';
    const card=document.createElement('div'); card.className='card';
    const h=document.createElement('h3'); h.textContent=`Search results for “${query}”`; card.appendChild(h);
    const small=document.createElement('div'); small.className='small'; small.textContent = isAdminSignedIn() ? 'Searching all mapped Drive folders (admin mode)…' : 'Searching public files in all mapped Drive folders…'; card.appendChild(small);
    const list=document.createElement('div'); list.className='list'; list.id='globalResults'; card.appendChild(list);
    view.appendChild(card);
  }

  function appendSearchItem(container, meta, f){
    const row=document.createElement('div'); row.className='item';
    const title=document.createElement('a'); title.className='title'; title.href='#'; title.onclick=(e)=>{ e.preventDefault(); openInlinePreview(f, isAdminSignedIn()); };
    const when=f.modifiedTime?new Date(f.modifiedTime).toLocaleString():'';
    const path = `${meta.bakery} › ${meta.machine} › ${CATS[meta.cat]?.title||meta.cat}`;
    title.innerHTML=`<div><strong>${escapeHtml(f.name)}</strong><div class="meta">${escapeHtml(path)} • ${escapeHtml(f.mimeType||'')} • ${escapeHtml(when)}</div></div>`;
    const dl=document.createElement('a'); dl.className='icon-btn'; dl.href = isAdminSignedIn() ? `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media` : `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media&key=${API_KEY}`; dl.target='_blank'; dl.rel='noopener';
    dl.innerHTML=`<svg viewBox="0 0 24 24" fill="none"><path d="M12 3v10m0 0 4-4m-4 4-4-4M4 20h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    row.append(title, dl); container.appendChild(row);
  }

  async function drawSearch(query){
    crumbsSet([{label:'Home',to:{}},{label:`Search: ${query}`,to:{q:query}}]);
    renderSearchResultsHeader(query);
    const list = document.getElementById('globalResults');
    list.innerHTML = '<div class="small">Scanning mapped folders…</div>';
    const concurrency = 6; let idx = 0, resultsCount = 0; list.innerHTML = '';

    async function worker(){
      while(idx < FOLDER_INDEX.length){
        const i = idx++; const meta = FOLDER_INDEX[i];
        try{
          const files = isAdminSignedIn() ? await searchFolderPrivate(meta.folderId, query) : await searchFolderPublic(meta.folderId, query);
          files.forEach(f => { appendSearchItem(list, meta, f); resultsCount++; });
        }catch(e){ /* ignore per-folder errors */ }
      }
    }

    const workers = Array.from({length: Math.min(concurrency, FOLDER_INDEX.length)}, worker);
    await Promise.all(workers);
    if(resultsCount === 0){ list.innerHTML = '<div class="small">No results.</div>'; }
  }

  /* ===== Upload helper ===== */
  async function uploadToDrive(folderId, file){
    const boundary='-------314159265358979323846';
    const delimiter=`\r\n--${boundary}\r\n`;
    const closeDelim=`\r\n--${boundary}--`;
    const meta={ name:file.name, parents:[folderId] };
    const ab=await file.arrayBuffer();
    const b64=btoa(String.fromCharCode(...new Uint8Array(ab)));
    const body=delimiter+'Content-Type: application/json; charset=UTF-8\r\n\r\n'+JSON.stringify(meta)+
               delimiter+'Content-Type: '+(file.type||'application/octet-stream')+'\r\nContent-Transfer-Encoding: base64\r\n\r\n'+b64+closeDelim;
    const r=await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink',{
      method:'POST', headers:{'Authorization':'Bearer '+accessToken,'Content-Type':'multipart/related; boundary='+boundary}, body
    });
    if(!r.ok){ const j=await r.json().catch(()=>({})); throw new Error(j.error?.message||'Upload failed'); }
    const created = await r.json();
    return created.id;
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

  /* ===== Router draw ===== */
  function draw(){
    const p=params();
    const b=p.get('bakery');
    const m=p.get('machine');
    const c=p.get('cat');
    const q=p.get('q');

    if(q){ drawSearch(q); return; }
    if(!b){ drawHome(); return; }
    if(b && !m){ drawBakery(b); return; }
    if(b && m && !c){ drawMachine(b,m); return; }
    if(b && m && c){ drawCategory(b,m,c); return; }
  }
  window.addEventListener('load', draw);

  /* ===== Global search form ===== */
  const gsForm = document.getElementById('globalSearchForm');
  const gsInput = document.getElementById('globalSearchInput');
  const clearBtn = document.getElementById('clearSearchBtn');
  if(gsForm){
    gsForm.addEventListener('submit', (e)=>{
      e.preventDefault(); const q = (gsInput.value||'').trim();
      if(q){ go({ q }); clearBtn.style.display=''; } else { go({}); clearBtn.style.display='none'; }
    });
  }
  if(clearBtn){ clearBtn.addEventListener('click', ()=>{ gsInput.value=''; go({}); clearBtn.style.display='none'; }); }

  /* ===== PIN gate ===== */
  const PIN_CODE = '2906';
  const lock = document.getElementById('lockscreen');
  const pinInput = document.getElementById('pinInput');
  const pinBtn = document.getElementById('pinBtn');
  const pinMsg = document.getElementById('pinMsg');
  function checkPin(){ if(pinInput.value === PIN_CODE){ lock.style.display = 'none'; sessionStorage.setItem('unlocked','1'); } else { pinMsg.style.display = 'block'; } }
  pinBtn.addEventListener('click', checkPin);
  pinInput.addEventListener('keypress', e=>{ if(e.key === 'Enter') checkPin(); });
  if(sessionStorage.getItem('unlocked') === '1'){ lock.style.display = 'none'; }
  </script>
</body>
</html>
