<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panelto Bakery</title>
<style>
  :root{ --bg:#f7fafc; --ink:#0f172a; --muted:#64748b; --card:#ffffff; --brand:#2563eb; --line:#e2e8f0; --zebra:#f8fafc; --hover:#eef2ff; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line);backdrop-filter:saturate(1.2) blur(4px)}
  .hwrap{max-width:1100px;margin:0 auto;padding:12px 14px;display:flex;align-items:center;gap:10px}
  .title{font-weight:800;letter-spacing:.2px}
  main{max-width:1100px;margin:0 auto;padding:14px}
  .stack{display:flex;flex-direction:column;gap:10px}
  .tile{display:block;background:linear-gradient(135deg,#fff,#f8fafc);border:1px solid var(--line);border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:18px 16px;text-decoration:none;color:inherit}
  .tile h2{margin:0 0 4px 0;font-size:1.1rem}
  .tile p{margin:0;color:var(--muted);font-size:.9rem}
  .tile:active{transform:translateY(1px)}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .square{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center}
  .c1{background:#fef3c7}.c2{background:#dbeafe}.c3{background:#d1fae5}.c4{background:#f3e8ff}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:12px}
  .crumbs{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0 12px}
  .crumbs a{color:var(--brand);text-decoration:none}
  .crumbs .sep{opacity:.45;color:var(--muted)}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
  input[type="search"],select{padding:8px 10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:var(--ink)}
  .btn{background:var(--brand);border:none;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--ink);border:1px solid #cbd5e1}
  .btn.badge{font-size:.9rem;padding:6px 10px}
  .small{font-size:.86rem;color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{display:flex;align-items:center;gap:12px;border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
  .item a.title{flex:1;text-decoration:none;color:inherit}
  .item a.title:hover{text-decoration:underline}
  .item .meta{font-size:.82rem;color:var(--muted);margin-top:4px}
  .icon-btn{min-width:34px;min-height:34px;border-radius:999px;border:1px solid #cbd5e1;background:#2563eb;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .icon-btn svg{width:16px;height:16px;display:block}

  /* Data table */
  .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:0 0 12px 12px;background:#fff}
  table.data{width:100%;border-collapse:separate;border-spacing:0;font-size:0.96rem}
  .data thead th{position:sticky;top:0;z-index:1;background:#f8fafc;border-bottom:1px solid var(--line);padding:10px;text-align:left;white-space:nowrap;user-select:none;cursor:pointer}
  .data thead th .hint{font-weight:600}
  .data thead th .sort{opacity:.7;margin-left:6px;font-size:.9em}
  .data tbody td{padding:10px;border-bottom:1px solid #eef2f7;vertical-align:top}
  .data tbody tr:nth-child(odd){background:var(--zebra)}
  .data tbody tr:hover{background:var(--hover)}
  .data .cell-mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.9em;color:#334155}
  .data td, .data th { overflow-wrap:anywhere; word-break:break-word; }
  .data td.wide, .data th.wide { min-width:420px; }           /* Job Description / Action Taken */
  .data td.asset, .data th.asset { min-width:260px; white-space:nowrap; } /* Asset column */

  /* Top horizontal scrollbar for wide tables (Work History) */
  .scroll-x-top{
    overflow-x:auto; overflow-y:hidden;
    height:14px; background:#fff;
    border:1px solid var(--line);
    border-bottom:0;
    border-radius:12px 12px 0 0;
  }
  .scroll-x-top::-webkit-scrollbar{height:12px}
  .scroll-x-top::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:8px}
  .scroll-x-top::-webkit-scrollbar-track{background:#f8fafc;border-radius:8px}

  footer{height:1px}
</style>
</head>
<body>
  <header>
    <div class="hwrap">
      <div class="title">Panelto Bakery</div>
      <form id="globalSearchForm" style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <input id="globalSearchInput" type="search" placeholder="Search all files…" aria-label="Search" style="padding:8px 10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:#1e293b;min-width:210px">
        <button class="btn" type="submit">Search</button>
        <button class="btn ghost" id="clearSearchBtn" type="button" style="display:none">Clear</button>
      </form>
    </div>
  </header>

  <!-- PIN lock -->
  <div id="lockscreen" style="position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f7fafc;z-index:9999;">
    <h2 style="margin-bottom:12px;font-family:Inter,sans-serif;color:#1e293b;">Enter Access Code</h2>
    <input type="password" id="pinInput" placeholder="Code" style="padding:10px 14px;border:1px solid #cbd5e1;background:#fff;color:#1e293b;border-radius:8px;font-size:1rem;">
    <button id="pinBtn" style="margin-top:12px;padding:10px 16px;border:none;border-radius:8px;background:#2563eb;color:#fff;font-size:1rem;cursor:pointer;">Unlock</button>
    <p id="pinMsg" style="color:#dc2626;margin-top:10px;display:none;">Wrong code</p>
  </div>

  <!-- PREVIEW MODAL -->
  <div id="previewBackdrop" style="position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;z-index:9998;">
    <div id="previewCard" style="position:absolute;left:50%;top:50%;transform:translate(-50%, -50%);width:min(100vw,1100px);height:min(100vh,88vh);background:#ffffff;border:1px solid #e2e8f0;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden;">
      <div style="display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #e2e8f0;background:#f8fafc;padding:8px 12px;">
        <div id="previewTitle" style="font-weight:600;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Preview</div>
        <div style="display:flex;gap:8px;align-items:center">
          <a id="previewDownload" class="btn" style="text-decoration:none;padding:6px 10px;border-radius:10px;background:#2563eb;color:#fff">Download</a>
          <button id="previewClose" class="btn ghost" style="padding:6px 10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:#1e293b">Close</button>
        </div>
      </div>
      <div id="wm" style="position:absolute;inset:0;pointer-events:none;display:none;align-items:center;justify-content:center;z-index:2">
        <div style="transform:rotate(-25deg);font-weight:800;font-size:48px;color:#0f172a12">CONFIDENTIAL — PANELTO</div>
      </div>
      <div id="previewBody" style="width:100%;height:calc(100% - 46px);background:#fff">
        <iframe id="previewFrame" style="width:100%;height:100%;border:0;display:block"></iframe>
        <video id="previewVideo" style="display:none;width:100%;height:100%" controls playsinline></video>
      </div>
    </div>
  </div>

  <main>
    <nav class="crumbs" id="crumbs"></nav>
    <section id="view">
      <div class="stack">
        <a class="tile" href="?bakery=Bakery%201"><h2>Bakery 1</h2><p>Open</p></a>
        <a class="tile" href="?bakery=Bakery%202"><h2>Bakery 2</h2><p>Open</p></a>
        <a class="tile" href="?bakery=Bakery%203"><h2>Bakery 3</h2><p>Open</p></a>
      </div>
    </section>
  </main>
  <footer></footer>

  <!-- Google Identity Services + Google API client -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>

  <script>
  /******** CONFIG ********/
  const CLIENT_ID = '937032004801-nfma3pp3fkkck4mfk094imqgmvduj7ih.apps.googleusercontent.com';
  const API_KEY   = 'AIzaSyDnEsld28xzG1lQROwBO_ImDq2SxX4kcg8';
  const SCOPES    = 'https://www.googleapis.com/auth/drive';

  const MACHINES = {
    'Bakery 1': ['Mixing','Fermentation','Fritsch','Proover','Oven','Cooler','Freezer'],
    'Bakery 2': ['Mixing','Fermentation','Spiro','Scarifier','Retarder','Rademaker','Proover','Pattyn Tilting Conveyer','Packing','Oven','MIB','Freezer','Cooler','Baggers','AHU'],
    'Bakery 3': ['Site 1 Packing','Site 2 Packing','Paletiser','Retail']
  };

  const FOLDERS = {
    'Bakery 1': {
      'Fritsch':      {documentation:'1uKMNjOdQltXZDMOrjs8nCDdQNdU0Dupw', works:'1M0NE6MtE0i-RNcckiFT8KCoMMwYdOdG_', electrical:'1RCWfvgcjDVCbutedlh3lyWjJ_kW5As9L', procedures:'1ismVYGrYFzwSbzxcoY_xki_KLhkdPpz0'},
      'Mixing':       {documentation:'1YG_ASV5ZG_rcSMKfcpjfU42w52CISWOn', works:'1NSIQBwmVfrocWgnMNOifWPDEmGx4dsc1', electrical:'1MiaraFYz59FaoMY_P-83-x5nyiB5-oFM', procedures:'1LMez4eD_gbCg70NBXxo73YgjZHthzs6U'},
      'Oven':         {documentation:'1t5dNT63qYVHzvH07UK4zqjs2c2jmdY0p', works:'1pu8f-rkqxH6x_q69X8xmCdEuCDambyjF', electrical:'1w1N5FbwoRPDYYkU3UvCINLece900dlMZ', procedures:'10sw8HYDASd0RrmgBysexwXnR45uKVpAB'},
      'Fermentation': {documentation:'1_7M91rSDdjP955aa3kVws2ckd6fMqhd2', works:'1qo4xBLzKMWuQivKdP_ae1d-sLrhIUFuj', electrical:'1J8VL8DAIq1NSpa0TMoO_RHcS9gAv4kL3', procedures:'1-6fpU69xeUINtjJZs5or9RQ8ijt4wvl0'},
      'Proover':      {documentation:'1teDMsKfN8BFiq4tI6ml2Z3zAYvq8TAp3', works:'1_UUtAmRYoUSRxypEIroIzNtXmdQ4V7lf', electrical:'1t46LgFl2vlCyWMRzt3nH4G8kUHjBYJa7', procedures:'1RPm3egkh7Lmx2TBxXps0v6npE-f54dJr'},
      'Freezer':      {documentation:'1-7C36DI_QIi-SHLPjOte9MVtE35EG5fN', works:'11H4BO7p-kPX2_3kPWW2wRzLp6Hk9JtPi', electrical:'1dQIp2J1HMv0gLYG4_P8B3D3sAHYEUBk9', procedures:'1oiO_33P7kT34wVM2oEbKQ8PGQcvk0M5P'},
      'Cooler':       {documentation:'1H7FGsJFHmKkarrIGsbW2OuoMKK69WfdZ', works:'15-7Vvr-4FyZ7zbfNUY17qh0Gi6Si-M02', electrical:'1MXGIDNGMstOwHEdrywqk-SRuJcf6WnJX', procedures:'1DGyNIYh62A82On7Q_TYeHnPMTZRdLsac'}
    },
    'Bakery 2': {
      'Mixing':       {documentation:'1_kzKmh_I-eZVktunneF5ALqMIVBFSANG', works:'1hmMsIkNbsQVlwHkQ8Ow5KVTA3vDwSPlH', electrical:'1VBfupXPwz3Pxhum3RCOZdCylW0AK7Mf0', procedures:'1q8fLx5e0MuLJAVh10Ea7oAONPyyomXXA'},
      'Fermentation': {documentation:'15r13fCr4CxGuK00Lbg-W__kjn5nET0Hj', works:'1wiSxlj8bkQ13lU3G701ztg8gNqiI6fyg', electrical:'1UOzZbFjwfCtQcWG04-xXN6vdJuNp0zwh', procedures:'1kN7MMl9TE0yCZ-J42860MWz4ZmGWF7Dw'},
      'Spiro':        {documentation:'1JZXSmYawAyyXvWT2jnUovaqX3D-fJ0EH', works:'1Q35Y56uV4yjwOr1140Eyj8TpOPMalvpc', electrical:'1QcxnK2LjNhSvv66_ae3kPV8K6vQfu4fI', procedures:'1NRoHEF1MesnbjzA1Cg5Q3vw1TtKhJSYD'},
      'Scarifier':    {documentation:'1m6I1Og91ma9-FEf4uGKq5OZ-sNJJLrG'.replace('5',''), works:'1yb5vRkm1fbluscJ41RNIv2_uFIMVHjGE', electrical:'1L3Pq0cBlKZ6SaTpBr4HANygvz4p4hmhI', procedures:'1Rxgeet6GRX_aHcfFJhNN8jK1hDH2m4Mg'},
      'Retarder':     {documentation:'1jg0FvErsRrnz_mOOeu3mCJAwX3AlJ26W', works:'1XqlFXZmukKz-tgVXoDMsXICQFgDcUVZE', electrical:'1i_azmPjg2oz5-4X8gLEbugT1dJ3-AzwF', procedures:'1ueMJa-EF_RMUvqQy-ETP1wkSswoAQkds'},
      'Rademaker':    {documentation:'1QRlaG20Rtc30iaKwdYbWHrNZId7k9URq', works:'1Li4ckJxG2qPOP8NQ13pDeHOgBo9Oig_H', electrical:'1qYv1EHkzzzdEMRT6aBFUYmNLHDVDcTUS', procedures:'1rPA3eIXUkBJyZqhQifAbYPcBDsbTa7EP'},
      'Proover':      {documentation:'1WcQWdVOYqqobaD8uoc3s5l1FCw8xkHim', works:'1J7FF4Rcmhpme0ltz0c6cmFvtNPCHHFSk', electrical:'1Az4ig6kyEK-ubVenXNJOmsTwTqezQDQ1', procedures:'1JuNU5TJvIW3mDHCkWHYbdqVBWlAmj83C'},
      'Pattyn Tilting Conveyer':{documentation:'1mI6mpPWbIRmOiwbl9iQdUvF9SHdISij2', works:'1QQH0oYPbNr_R1wj8VxIMwlFvW0x4zza2', electrical:'1zJ8v5-ghuO7x9RbtttIbVttj7e9b5Q-i', procedures:'1wj2BtkPnTQvEuyluzseBXxrkK9OGB7in'},
      'Packing':      {documentation:'1tTpmHrNiK3eO-8UME6amkBGcBCqogOoG', works:'1jxDJO0hSSHQ-8KIQSQUcCmocq0jyGQWb', electrical:'14PUHHjr0GOtNaMQPTADKCxj7pZCa9Do5', procedures:'1myVmfW9HnlfRdM-FMeAx1REqaiSBhqFs'},
      'Oven':         {documentation:'1GHVtXJi0KMPdIf7z_W0SGU0BiudjQPSO', works:'1wOn_2XRKn9WP8PK8quuL9fGxS56-GMJp', electrical:'1DGl4po1gULH2gQkYC_4I5eWemomZf_D8', procedures:'1mknL-hrBx3AbPbpMElftIyKkqqs1jwnM'},
      'MIB':          {documentation:'1twize6Omq1WUxt631UIlvXoWG6Kmy-XS', works:'1gbII6qemYbyQVSjGivbn8_Ku6cEFX1pR', electrical:'1c4vr73nrDie8sGfGz2VqvMMYhGh1z-Fn', procedures:'1NI0RK4Mp6zeyJ0R1PFfam_auoHJAMRfs'},
      'Freezer':      {documentation:'1C4mCKM1DkXJwD-gVMf4spO8REjc6LDTC', works:'1vnbdMMISy38_SiJpVOuVoyC0UUEDaZaV', electrical:'1xqcwh5GvmZgSkCyffzQNINw4P_91W4Df', procedures:'1X14Fgcb8rESKIGQNXVo1bVT9cYn_f4s6'},
      'Cooler':       {documentation:'1tEemK1qcOlAn55CLOCWyUgS4PdASNbQ5', works:'1CUMUsoIRNl0PO8mQoK0-EmgHxMFuZLXI', electrical:'1dHbBL4-iVcekRBlTIr7jdUz17kL8MZUj', procedures:'1fcL8I_FZqD_JEmiuerWKyGN_8TJo09hU'},
      'Baggers':      {documentation:'1llq6U95hQc3NcGg1JDqOBKbmxJxsYcUR', works:'1HrGgPLFF4sUmc2FXsBlr_KNgdiEmnyUJ', electrical:'1J1W8STCRjfGfv4q91ZyxkyKiEUev_cAA', procedures:'1GewCaKsiOLEukax4ZIZTSP42kWFR280'},
      'AHU':          {documentation:'1QMKYSOQ-N0LVANk8MZNiB07DTKI-QC7U', works:'1tSXor0e_YtcabRFabUO_AOhEMjzTttuh', electrical:'1m3CYpvbWyqJBX022oiOwJNcBayqOFF1a', procedures:'1PcPbWgBbTDnPZAidlPI-_T4-fpJP2q0o'}
    },
    'Bakery 3': {
      'Site 1 Packing': {documentation:'1J210oJpvaS2VhXOMaQm8oXAFbCW8FDa7', works:'1emCk6hQQF25eMn8D7LyJD4uyqt4vFfQW', electrical:'1mG4EyGxk4Be4nbV_WW316FqzuTl1QCR-', procedures:'1DJwbexql1dakzKXYdvofvFam9vTuikS'.replace('d','')},
      'Site 2 Packing': {documentation:'1OovqnA9jsAdFJSxeeWj9Dr9K4VUya5yi', works:'15C_uMSqzoJjdSpBfE6xVpBEbiWeBgZn-', electrical:'17pLXNKAOomUOwo642WazWVboOwJiZPCl', procedures:'1u1Ipt5v375gwd8CufIkc3TckKTQA-dKE'},
      'Paletiser':      {documentation:'1exaNF6HaJVw4D8ODVdDDiurYhxGzmn-8', works:'1Nd3vqzlvIw2reDo2ELeCw5q_UC5YRR8y', electrical:'1r8lSFtNAwSoMpPSVouj7Jv39WeL5xmXw', procedures:'1CNgEId5CKxNlMcwmZxJsIG0DQB266s5Y'},
      'Retail':         {documentation:'1tghnGJ1e09FnOwhTV1UKZpSl-XRT62On', works:'1hoUvzxjpA6z2TTggwiSj-7CMfkQ40rCB', electrical:'1QIkmIstBW4RKryafamYp38Jnr3DLLtlm', procedures:'1soZAoyN9pp4xTkKcQczMH37Yqx8t48EA'}
    }
  };

  const CATS = {
    documentation: { title:'Documentation',   color:'c1', desc:'User manuals & technical docs' },
    works:         { title:'Work History',    color:'c2', desc:'Repairs, interventions' },
    electrical:    { title:'Electrical Diagrams', color:'c3', desc:'Wiring & schematics' },
    procedures:    { title:'Procedures',      color:'c4', desc:'SOPs & guides' }
  };

  /* === Work History preko Google Sheets === */
  const WORKS_SHEETS = {
    'Bakery 1': {
      'Fritsch': {
        sheetId: '1j3KX2qGjFj9tOHWZLKY_xJMV70wBr5KQfZab0-TYw0k',
        sheetName: 'Work History without routines',
        gid: '1835750486'
      },
      'Mixing': { sheetId: '1-8xwFTKmxRhi4IqwhEw7ugCWgxHKhZit9LOcWUZgcxw', sheetName: 'Work Histories', gid: '0'},

    },
    'Bakery 2': {},
    'Bakery 3': {}
  };

  /* ===== Utilities ===== */
  function params(){ return new URLSearchParams(location.search); }
  function go(obj){ const u=new URL(location.href); u.search=new URLSearchParams(obj).toString(); history.pushState({},'',u); draw(); }
  window.addEventListener('popstate', draw);

  function crumbsSet(items){
    const el = document.getElementById('crumbs');
    el.innerHTML='';
    items.forEach((it,i)=>{
      const a=document.createElement('a');
      a.href='javascript:void(0)';
      a.textContent=it.label;
      a.onclick=()=>{ go(it.to||{}); };
      el.appendChild(a);
      if(i<items.length-1){
        const s=document.createElement('span');
        s.className='sep'; s.textContent='›'; el.appendChild(s);
      }
    });
  }

  function drawHome(){
    crumbsSet([{label:'Home'}]);
    const view=document.getElementById('view');
    view.innerHTML='';
    const wrap=document.createElement('div'); wrap.className='stack';
    Object.keys(MACHINES).forEach(b=>{
      const a=document.createElement('a');
      a.className='tile';
      a.href=`?bakery=${encodeURIComponent(b)}`;
      a.innerHTML=`<h2>${b}</h2><p>Open</p>`;
      wrap.appendChild(a);
    });
    view.appendChild(wrap);
  }

  function drawBakery(b){
    crumbsSet([{label:'Home',to:{}},{label:b,to:{bakery:b}}]);
    const view=document.getElementById('view'); view.innerHTML='';
    const machines = MACHINES[b]||[];
    if(!machines.length){ drawMachine(b,'—'); return; }
    const wrap=document.createElement('div'); wrap.className='stack';
    machines.forEach(m=>{
      const a=document.createElement('a');
      a.className='tile';
      a.href=`?bakery=${encodeURIComponent(b)}&machine=${encodeURIComponent(m)}`;
      a.innerHTML=`<h2>${m}</h2><p>Open</p>`;
      wrap.appendChild(a);
    });
    view.appendChild(wrap);
  }

  function drawMachine(b,m){
    crumbsSet([{label:'Home',to:{}},{label:b,to:{bakery:b}},{label:m,to:{bakery:b,machine:m}}]);
    const view=document.getElementById('view'); view.innerHTML='';
    const card=document.createElement('div'); card.className='card';
    const h=document.createElement('h3'); h.textContent=`${b} › ${m}`; card.appendChild(h);
    const grid=document.createElement('div'); grid.className='grid';
    Object.entries(CATS).forEach(([k,meta])=>{
      const a=document.createElement('a');
      a.className=`tile square ${meta.color}`;
      a.href=`?bakery=${encodeURIComponent(b)}&machine=${encodeURIComponent(m)}&cat=${encodeURIComponent(k)}`;
      a.innerHTML=`<h2>${meta.title}</h2><p>${meta.desc}</p>`;
      grid.appendChild(a);
    });
    card.appendChild(grid);
    document.getElementById('view').appendChild(card);
  }

  /* === Inline preview helpers (supports inline <video>) === */
  const previewBackdrop = document.getElementById('previewBackdrop');
  const previewFrame   = document.getElementById('previewFrame');
  const previewVideo   = document.getElementById('previewVideo');
  const previewTitleEl = document.getElementById('previewTitle');
  const previewCloseBtn= document.getElementById('previewClose');
  const previewDownload= document.getElementById('previewDownload');
  const wmEl           = document.getElementById('wm');

  function showPreview(){ previewBackdrop.style.display = 'block'; }
  function hidePreview(){
    previewBackdrop.style.display = 'none';
    try{ if(previewFrame.dataset.blobUrl){ URL.revokeObjectURL(previewFrame.dataset.blobUrl); previewFrame.dataset.blobUrl=''; } }catch{}
    try{ if(previewVideo.dataset.blobUrl){ URL.revokeObjectURL(previewVideo.dataset.blobUrl); previewVideo.dataset.blobUrl=''; } }catch{}
    previewFrame.src = 'about:blank';
    previewVideo.pause(); previewVideo.removeAttribute('src'); previewVideo.style.display='none';
    previewFrame.style.display='block';
  }
  previewBackdrop.addEventListener('click', (e)=>{ if(e.target === previewBackdrop) hidePreview(); });
  previewCloseBtn.addEventListener('click', hidePreview);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && previewBackdrop.style.display==='block') hidePreview(); });

  function isPdf(mime){ return (mime||'').toLowerCase().includes('pdf') || /\.pdf$/i.test(mime||''); }
  function isImage(mime,name){ return (mime||'').startsWith('image/') || /\.(png|jpe?g|gif|bmp|webp|svg)$/i.test(name||''); }
  function isVideo(mime,name){ return (mime||'').startsWith('video/') || /\.(mp4|mov|mkv|webm|avi)$/i.test(name||''); }
  function publicDownloadUrl(fileId){ return `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${API_KEY}`; }

  async function fetchPrivateBlob(fileId){
    const r = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, { headers:{'Authorization':'Bearer '+accessToken} });
    if(!r.ok) throw new Error('Fetch failed '+r.status);
    return await r.blob();
  }

  async function openInlinePreview(f,isAdmin){
    try{
      previewTitleEl.textContent = f.name || 'Preview';
      previewDownload.href = isAdmin ? `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media` : publicDownloadUrl(f.id);
      const previewUrl = `https://drive.google.com/file/d/${f.id}/preview`;
      const showWm = new URLSearchParams(location.search).get('wm')==='1';
      wmEl.style.display = showWm ? 'flex' : 'none';

      // Inline video playback
      if (isVideo(f.mimeType, f.name)){
        try{
          if(isAdmin){
            const blob = await fetchPrivateBlob(f.id);
            const url = URL.createObjectURL(blob);
            previewVideo.dataset.blobUrl = url;
            previewVideo.src = url;
          } else {
            previewVideo.src = publicDownloadUrl(f.id);
          }
          previewFrame.style.display='none';
          previewVideo.style.display='block';
          showPreview();
          return;
        }catch(e){ console.warn('Video inline failed, fallback to Drive preview'); }
      }

      // Images & PDFs inline
      if (isPdf(f.mimeType) || isImage(f.mimeType, f.name)){
        if(isAdmin){
          try{
            const blob = await fetchPrivateBlob(f.id);
            const url = URL.createObjectURL(blob);
            previewFrame.dataset.blobUrl = url;
            previewFrame.src = url; showPreview(); return;
          }catch(e){ console.warn('Blob preview failed, fallback to Drive preview'); }
        }
        previewFrame.src = previewUrl; showPreview(); return;
      }

      // Other types → Drive viewer
      window.open(f.webViewLink || `https://drive.google.com/file/d/${f.id}/view`, '_blank');
    }catch(e){ alert('Preview failed: '+(e.message||String(e))); }
  }

  /* ===== Drive & Auth ===== */
  let accessToken=null,gapiReady=false;
  async function ensureGapi(){
    if(gapiReady) return;
    await new Promise(r=>gapi.load('client',r));
    await gapi.client.init({apiKey:API_KEY,discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']});
    gapiReady=true;
  }
  async function ensureAuth(){
    if(accessToken) return accessToken;
    await ensureGapi();
    return new Promise((res,rej)=>{
      const c=google.accounts.oauth2.initTokenClient({
        client_id:CLIENT_ID,
        scope:SCOPES,
        callback:r=>{ if(r&&r.access_token){accessToken=r.access_token;res(accessToken);} else rej(new Error('No token')); }
      });
      c.requestAccessToken({prompt:'consent'});
    });
  }
  function isAdminSignedIn(){ return !!accessToken; }
  function folderIdFor(b,m,cat){ return FOLDERS?.[b]?.[m]?.[cat] || null; }

  /* ===== SHEET HELPERS (robust) ===== */
  function parseCsvTable(text){
    const rows = [];
    let row = [], inQuotes = false, field = '';
    for (let i=0; i<text.length; i++){
      const ch = text[i], next = text[i+1];
      if (inQuotes){
        if (ch === '"' && next === '"'){ field += '"'; i++; }
        else if (ch === '"'){ inQuotes = false; }
        else { field += ch; }
      } else {
        if (ch === '"'){ inQuotes = true; }
        else if (ch === ','){ row.push(field); field=''; }
        else if (ch === '\n'){ row.push(field); rows.push(row); row=[]; field=''; }
        else if (ch === '\r'){ /* ignore */ }
        else { field += ch; }
      }
    }
    if (field.length || row.length) { row.push(field); rows.push(row); }
    const headers = (rows.shift() || []).map(h => String(h||'').trim());
    return { headers, rows };
  }

  // Parse GViz Date(...) / Excel serial / common text dates
  function parseDateSmart(v){
    if (v == null) return NaN;
    if (v instanceof Date) { const t=v.getTime(); return isNaN(t)?NaN:t; }

    if (typeof v === 'string' && /^Date\(\d{4},\d{1,2},\d{1,2}(,\d{1,2},\d{1,2}(,\d{1,2})?)?\)$/.test(v)){
      const nums=v.slice(5,-1).split(',').map(n=>parseInt(n,10));
      const [Y,M,D,h=0,m=0,s=0]=nums; // GViz month is 0-based
      const dt=new Date(Y, M, D, h, m, s);
      return dt.getTime();
    }
    if (typeof v === 'number' && isFinite(v)){
      const ms=(v-25569)*86400*1000; return isNaN(ms)?NaN:ms;
    }
    const t=String(v).trim(); if(!t) return NaN;
    if(/^\d+(\.\d+)?$/.test(t)){ const n=Number(t); if(isFinite(n)){ const ms=(n-25569)*86400*1000; return isNaN(ms)?NaN:ms; } }
    let d=Date.parse(t); if(!Number.isNaN(d)) return d;
    let m=t.match(/^(\d{1,2})[\/.\-\s](\d{1,2})[\/.\-\s](\d{2,4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
    if(m){ let dd=+m[1], mm=+m[2], yy=+m[3]; let hh=+(m[4]??0), mi=+(m[5]??0), ss=+(m[6]??0); if(yy<100) yy+=(yy>=70?1900:2000); const dt=new Date(yy,mm-1,dd,hh,mi,ss); return isNaN(dt.getTime())?NaN:dt.getTime(); }
    m=t.match(/^(\d{4})[\/.\-\s](\d{1,2})[\/.\-\s](\d{1,2})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
    if(m){ const yy=+m[1], mm=+m[2], dd=+m[3]; let hh=+(m[4]??0), mi=+(m[5]??0), ss=+(m[6]??0); const dt=new Date(yy,mm-1,dd,hh,mi,ss); return isNaN(dt.getTime())?NaN:dt.getTime(); }
    return NaN;
  }

  function formatDateCell(v){
    const ms = parseDateSmart(v);
    if (isNaN(ms)) return String(v ?? '');
    const d = new Date(ms);
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    const hh = d.getHours();
    const mi = d.getMinutes();
    const ss = d.getSeconds();
    const base = `${dd}.${mm}.${yyyy}`; // dd.mm.yyyy
    const timePresent = (hh+mi+ss) !== 0;
    return timePresent ? `${base} ${String(hh).padStart(2,'0')}:${String(mi).padStart(2,'0')}` : base;
  }

  // Fetch Google Sheet table with types; prefer formatted display strings
  async function fetchSheetTable(sheetId, sheetName, gid){
    if (sheetName) {
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('GViz JSON HTTP ' + res.status);
        let text = await res.text();
        text = text.replace(/^\)\]\}'\s*/, '').replace(/^\uFEFF/, '');
        const start = text.indexOf('{'), end = text.lastIndexOf('}');
        if (start === -1 || end === -1 || end <= start) throw new Error('Invalid GViz JSON payload');
        const data = JSON.parse(text.substring(start, end + 1));

        const cols=(data.table.cols||[]);
        const headers = cols.map(c => (c && (c.label || c.id)) || '');
        const types = cols.map(c => (c && c.type) || 'string').map(t => t==='date'||t==='datetime' ? 'date' : (t==='number' ? 'number' : 'text'));
        const rows = (data.table.rows||[]).map(r => (r.c||[]).map(c => {
          if(!c) return '';
          if (c.f != null && c.f !== '') return c.f; // prefer formatted text from Sheets
          if (typeof c.v === 'string' && /^Date\(/.test(c.v)) return c.v; // otherwise keep GViz literal
          return (c.v ?? '');
        }));

        const looksLikeLetters = headers.length && headers.every(h => !h || /^[A-Z]+$/.test(String(h)));
        const allEmpty = headers.every(h => !h || String(h).trim()==='');
        let hdrs=headers, rws=rows, tys=types;
        if ((allEmpty || looksLikeLetters) && rows.length){ hdrs = rows[0].map(v => String(v||'').trim()); rws = rows.slice(1); }
        return { headers: hdrs, rows: rws, types: tys };
      } catch (e) {
        try {
          const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
          const rCsv = await fetch(csvUrl);
          if (!rCsv.ok) throw new Error('GViz CSV HTTP ' + rCsv.status);
          return parseCsvTable(await rCsv.text());
        } catch (e2) {
          if (gid) {
            const urlCsv = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&id=${sheetId}&gid=${gid}`;
            const rCsv2 = await fetch(urlCsv);
            if (!rCsv2.ok) throw new Error('CSV export HTTP ' + rCsv2.status);
            return parseCsvTable(await rCsv2.text());
          }
          throw e2;
        }
      }
    }
    if (gid) {
      const urlCsv = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&id=${sheetId}&gid=${gid}`;
      const rCsv = await fetch(urlCsv);
      if (!rCsv.ok) throw new Error('CSV export HTTP ' + rCsv.status);
      return parseCsvTable(await rCsv.text());
    }
    throw new Error('No sheetName or gid configured.');
  }

  /* ===== Work History renderer (with top scrollbar) ===== */
  function renderWorksTable(container, table, sheetId){
    container.innerHTML = '';

    const bar = document.createElement('div'); bar.className='toolbar';
    const search = document.createElement('input'); search.type='search'; search.placeholder='Search…';
    const adminBtns = document.createElement('div'); adminBtns.style.display='flex'; adminBtns.style.gap='8px'; adminBtns.style.marginLeft='auto';
    const dlBtn = document.createElement('button'); dlBtn.className='btn ghost badge'; dlBtn.textContent='Download CSV';
    const openGs = document.createElement('button'); openGs.className='btn ghost badge'; openGs.textContent='Open in Google Sheets (Admin)';
    adminBtns.append(dlBtn, openGs);
    adminBtns.style.display = isAdminSignedIn() ? 'flex' : 'none';
    bar.append(search, adminBtns);
    container.appendChild(bar);

    /* ⬇️ Gornji horizontalni klizač */
    const topScroll = document.createElement('div');
    topScroll.className = 'scroll-x-top';
    const topInner = document.createElement('div');
    topInner.style.height = '1px';
    topScroll.appendChild(topInner);
    container.appendChild(topScroll);

    const wrap = document.createElement('div'); wrap.className='table-wrap';
    const tableEl = document.createElement('table'); tableEl.className='data';
    wrap.appendChild(tableEl); container.appendChild(wrap);

    const thead = document.createElement('thead');
    const trh = document.createElement('tr');

    const wideIdx = new Set();
    let assetCol = -1;
    table.headers.forEach((h,i)=>{
      if (/job\s*description/i.test(h)) wideIdx.add(i);
      if (/action\s*taken/i.test(h))     wideIdx.add(i);
      if (/(^|\b)asset(\b|$)/i.test(h||'')) { assetCol = i; wideIdx.add(i); }
    });

    table.headers.forEach((h, idx) => {
      const th = document.createElement('th');
      th.innerHTML = `<span class="hint">${escapeHtml(h||`Col ${idx+1}`)}</span><span class="sort">⇅</span>`;
      if (wideIdx.has(idx)) th.classList.add('wide');
      if (idx === assetCol) th.classList.add('asset');
      th.addEventListener('click', () => sortBy(idx));
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    tableEl.appendChild(thead);

    const tbody = document.createElement('tbody');
    tableEl.appendChild(tbody);

    let currentRows = table.rows.slice();

    const inferredTypes = (table.types && table.types.length===table.headers.length)
      ? table.types.slice()
      : table.headers.map((_, col) => {
          let isDate=true, isNum=true;
          for (let i=0;i<Math.min(currentRows.length, 30);i++){
            const v = currentRows[i][col];
            if (v==null || v==='') continue;
            const n = Number(v);
            if (!isFinite(n)) isNum=false;
            const d = parseDateSmart(v);
            if (isNaN(d)) isDate=false;
            if (!isDate && !isNum) break;
          }
          return isDate ? 'date' : (isNum ? 'number' : 'text');
        });

    let sortCol = -1, sortDir = 1;

    function cmp(a,b,col){
      const t = inferredTypes[col];
      const va = a[col], vb = b[col];
      if (t==='date'){
        const na = parseDateSmart(va);
        const nb = parseDateSmart(vb);
        if (isNaN(na) && isNaN(nb)) return 0;
        if (isNaN(na)) return 1;
        if (isNaN(nb)) return -1;
        return na - nb;                // najstarije → najnovije
      } else if (t==='number'){
        const na = Number(va); const nb = Number(vb);
        if (isNaN(na) && isNaN(nb)) return 0;
        if (isNaN(na)) return 1;
        if (isNaN(nb)) return -1;
        return na - nb;
      } else {
        const sa = String(va||'').toLowerCase();
        const sb = String(vb||'').toLowerCase();
        if (sa<sb) return -1;
        if (sa>sb) return 1;
        return 0;
      }
    }

    function updateSortIndicators(){
      const ths = thead.querySelectorAll('th .sort');
      ths.forEach((el, i)=>{
        el.textContent = (i===sortCol) ? (sortDir===1 ? '↑' : '↓') : '⇅';
        el.style.opacity = (i===sortCol) ? '1' : '.7';
      });
    }

    function displayValue(v, i){
      if (inferredTypes[i]==='date') return formatDateCell(v);
      if (inferredTypes[i]==='number') return String(v);
      return String(v ?? '');
    }

    /* ⬇️ sinkronizacija gornjeg i donjeg scrolla */
    function syncTopWidth(){
      topInner.style.width = tableEl.scrollWidth + 'px';
    }
    function syncFromTop(){ wrap.scrollLeft = topScroll.scrollLeft; }
    function syncFromBottom(){ topScroll.scrollLeft = wrap.scrollLeft; }
    topScroll.addEventListener('scroll', syncFromTop, {passive:true});
    wrap.addEventListener('scroll', syncFromBottom, {passive:true});
    window.addEventListener('resize', ()=>requestAnimationFrame(syncTopWidth));

    function renderBody(){
      const q = (search.value||'').toLowerCase();
      tbody.innerHTML = '';
      currentRows.forEach(r => {
        if(q){
          const hit = r.some(v => String(v||'').toLowerCase().includes(q));
          if(!hit) return;
        }
        const tr = document.createElement('tr');
        r.forEach((v, i)=>{
          const td = document.createElement('td');
          const val = displayValue(v, i);
          if (wideIdx.has(i)) td.classList.add('wide');
          if (i === assetCol) td.classList.add('asset');
          if (inferredTypes[i]==='number') td.classList.add('cell-mono');
          td.textContent = val;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      requestAnimationFrame(syncTopWidth); // osvježi širinu gornjeg slidera
    }

    function sortBy(colIdx){
      if(sortCol === colIdx){ sortDir *= -1; } else { sortCol = colIdx; sortDir = 1; }
      currentRows.sort((a,b)=> sortDir * cmp(a,b,colIdx) );
      updateSortIndicators();
      renderBody();
    }

    // inicijalno: sort po "Completed On" ako postoji, najstarije→najnovije
    const completedCol = table.headers.findIndex(h =>
      h && /^(completed\s*on|completed|completion\s*date|date\s*completed)$/i.test(String(h).trim())
    );
    if (completedCol !== -1){
      sortCol = completedCol;
      sortDir = 1;
      currentRows.sort((a,b)=> sortDir * cmp(a,b,completedCol) );
    }

    updateSortIndicators();
    renderBody();

    search.addEventListener('input', renderBody);

    dlBtn.onclick = ()=>{
      const esc =(s)=>('"'+String(s??'').replace(/"/g,'""')+'"');
      const lines = [ table.headers.map(esc).join(','), ...currentRows.map(row=>row.map(esc).join(',')) ].join('\r\n');
      const blob = new Blob([lines], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='work_history.csv'; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 5000);
    };
    openGs.onclick = async ()=>{
      try{
        if(!isAdminSignedIn()) await ensureAuth();
        if (sheetId) window.open(`https://docs.google.com/spreadsheets/d/${sheetId}/edit`, '_blank');
        else alert('Sheet ID not found');
      }catch(e){ alert('Admin sign-in failed: ' + (e.message || String(e))); }
    };

    const reveal = ()=>{ adminBtns.style.display = isAdminSignedIn() ? 'flex' : 'none'; };
    setInterval(reveal, 800);
  }

  async function drawWorksSheetView(bakery, machine, container){
    const entry = WORKS_SHEETS?.[bakery]?.[machine];
    if(!entry || !entry.sheetId){
      container.innerHTML = '<div class="small">No Google Sheet configured for this machine. Showing Drive folder instead.</div>';
      return null;
    }
    try{
      container.innerHTML = '<div class="small">Loading Work History…</div>';
      const table = await fetchSheetTable(entry.sheetId, entry.sheetName||'Sheet1', entry.gid);
      renderWorksTable(container, table, entry.sheetId);
      return true;
    }catch(e){
      container.innerHTML = `<div class="small">Failed to load Work History: ${escapeHtml(e.message||String(e))}</div>`;
      return true;
    }
  }

  /* ===== CATEGORY VIEW ===== */
  function drawCategory(b,m,catKey){
    const cat=CATS[catKey];
    if(!cat){ go({bakery:b,machine:m}); return; }

    crumbsSet([
      {label:'Home',to:{}},
      {label:b,to:{bakery:b}},
      {label:m,to:{bakery:b,machine:m}},
      {label:cat.title,to:{bakery:b,machine:m,cat:catKey}}
    ]);

    const view=document.getElementById('view'); view.innerHTML='';
    const card=document.createElement('div'); card.className='card';
    const h=document.createElement('h3'); h.textContent=`${b} › ${m} › ${cat.title}`; card.appendChild(h);

    const fid = folderIdFor(b,m,catKey);
    const hint = document.createElement('div'); hint.className='small'; card.appendChild(hint);
    function refreshHint(){
      if(!fid){ hint.style.display = ''; hint.innerHTML = '⚠️ Set Drive folder ID in <code>FOLDERS</code>.'; }
      else if (accessToken) { hint.style.display = ''; hint.innerHTML = `Folder ID: <code>${escapeHtml(fid)}</code>`; }
      else { hint.style.display = 'none'; hint.innerHTML = ''; }
    }
    refreshHint();

    const bar=document.createElement('div'); bar.className='toolbar';
    const search=document.createElement('input'); search.type='search'; search.placeholder='Search files';
    const refresh=document.createElement('button'); refresh.className='btn ghost'; refresh.textContent='Refresh';
    const adminBtn=document.createElement('button'); adminBtn.className='btn ghost'; adminBtn.textContent='Admin: Sign in';
    const openFolderBtn=document.createElement('button'); openFolderBtn.className='btn'; openFolderBtn.textContent='Open Drive folder (Admin)'; openFolderBtn.style.display='none';
    openFolderBtn.onclick=()=>{ if(fid) window.open(`https://drive.google.com/drive/folders/${fid}`, '_blank'); };

    bar.append(adminBtn, openFolderBtn, search, refresh); card.appendChild(bar);

    const list=document.createElement('div'); list.className='list'; card.appendChild(list);
    view.appendChild(card);

    if (catKey === 'works') {
      const sheetEntry = WORKS_SHEETS?.[b]?.[m];
      if (sheetEntry && sheetEntry.sheetId) {
        refresh.style.display = 'none';
        drawWorksSheetView(b, m, list).catch(e => { list.innerHTML = `<div class="small">Failed to load Work History: ${escapeHtml(e.message||String(e))}</div>`; });
        adminBtn.onclick = async () => { try{ await ensureAuth(); adminBtn.style.display='none'; refreshHint(); openFolderBtn.style.display=''; }catch(e){ alert('Sign-in failed: ' + (e.message || String(e))); } };
        return;
      }
    }

    /* PUBLIC listing */
    async function publicListFiles(){
      list.innerHTML='<div class="small">Loading…</div>';
      try{
        if(!fid){ list.innerHTML='<div class="small">Set Drive folder ID.</div>'; return; }
        const params=new URLSearchParams({
          q:`'${fid}' in parents and trashed=false`,
          fields:'files(id,name,modifiedTime,mimeType,webViewLink)',
          orderBy:'modifiedTime desc', pageSize:'100', key:API_KEY,
          supportsAllDrives:'true', includeItemsFromAllDrives:'true'
        });
        const res=await fetch('https://www.googleapis.com/drive/v3/files?'+params.toString());
        if(!res.ok){ const j=await res.json().catch(()=>({})); throw new Error(j.error?.message||('HTTP '+res.status)); }
        const data=await res.json();
        let items=data.files||[];
        const s=(search.value||'').toLowerCase(); if(s) items=items.filter(f=>(f.name||'').toLowerCase().includes(s));
        if(!items.length){ list.innerHTML='<div class="small">No files yet.</div>'; return; }
        list.innerHTML='';
        items.forEach(f=>{
          const row=document.createElement('div'); row.className='item';
          const title=document.createElement('a'); title.className='title'; title.href='#';
          title.onclick=(e)=>{ e.preventDefault(); openInlinePreview(f,false); };
          const when=f.modifiedTime?new Date(f.modifiedTime).toLocaleString():'';
          title.innerHTML=`<div><strong>${escapeHtml(f.name)}</strong><div class="meta">${escapeHtml(f.mimeType||'')} • ${escapeHtml(when)}</div></div>`;
          const dl=document.createElement('a'); dl.className='icon-btn'; dl.href=publicDownloadUrl(f.id); dl.target='_blank'; dl.rel='noopener';
          dl.innerHTML=`<svg viewBox="0 0 24 24" fill="none"><path d="M12 3v10m0 0 4-4m-4 4-4-4M4 20h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
          row.append(title,dl); list.appendChild(row);
        });
      }catch(e){ list.innerHTML=`<div class="small">Public list error: ${escapeHtml(e.message||String(e))}</div>`; }
    }

    /* PRIVATE listing (admin) — with DELETE */
    async function privateListFiles(){
      list.innerHTML='<div class="small">Loading…</div>';
      try{
        if(!fid){ list.innerHTML='<div class="small">Set Drive folder ID.</div>'; return; }
        const q=`'${fid}' in parents and trashed=false`;
        const res=await gapi.client.drive.files.list({ q, fields:'files(id,name,modifiedTime,mimeType,webViewLink)', orderBy:'modifiedTime desc', pageSize:100, supportsAllDrives:true, includeItemsFromAllDrives:true });
        let items=res.result.files||[];
        const s=(search.value||'').toLowerCase(); if(s) items=items.filter(f=>(f.name||'').toLowerCase().includes(s));
        if(!items.length){ list.innerHTML='<div class="small">No files yet.</div>'; return; }
        list.innerHTML='';
        items.forEach(f=>{
          const row=document.createElement('div'); row.className='item';
          const title=document.createElement('a'); title.className='title'; title.href='#'; title.onclick=(e)=>{ e.preventDefault(); openInlinePreview(f,true); };
          const when=f.modifiedTime?new Date(f.modifiedTime).toLocaleString():'';
          title.innerHTML=`<div><strong>${escapeHtml(f.name)}</strong><div class="meta">${escapeHtml(f.mimeType||'')} • ${escapeHtml(when)}</div></div>`;
          const right=document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
          const dl=document.createElement('a'); dl.className='icon-btn'; dl.href=`https://www.googleapis.com/drive/v3/files/${f.id}?alt=media`; dl.target='_blank'; dl.rel='noopener';
          dl.innerHTML=`<svg viewBox="0 0 24 24" fill="none"><path d="M12 3v10m0 0 4-4m-4 4-4-4M4 20h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
          const del=document.createElement('button'); del.className='icon-btn';
          del.innerHTML=`<svg viewBox="0 0 24 24" fill="none"><path d="M6 7h12M10 7v12m4-12v12M9 7l1-2h4l1 2M6 7l1 14h10l1-14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
          del.onclick=async()=>{
            if(!confirm('Delete file?')) return;
            try{ await gapi.client.drive.files.delete({fileId:f.id}); await privateListFiles(); }
            catch(e){ alert('Delete failed: '+(e.result?.error?.message||e.message)); }
          };
          right.append(dl, del); row.append(title, right); list.appendChild(row);
        });
      }catch(e){ list.innerHTML=`<div class='small'>Error: ${escapeHtml(e.message||String(e))}</div>`; }
    }

    // Init: public
    publicListFiles();
    refresh.onclick = publicListFiles;
    search.oninput = publicListFiles;

    adminBtn.onclick = async () => {
      try{
        await ensureAuth();
        refreshHint(); openFolderBtn.style.display=''; adminBtn.style.display='none';
        refresh.onclick = privateListFiles; search.oninput = privateListFiles; await privateListFiles();
        const signOut = document.createElement('button'); signOut.className='btn ghost'; signOut.textContent='Admin: Sign out';
        signOut.onclick = ()=>{ accessToken=null; alert('Signed out. Refresh to return to public mode.'); };
        bar.append(signOut);
      }catch(e){ alert('Sign-in failed: ' + (e.message || String(e))); }
    };
  }

  /* ===== GLOBAL SEARCH ===== */
  function buildFolderIndex(){
    const out=[];
    for(const bakery of Object.keys(FOLDERS||{})){
      const machinesObj = FOLDERS[bakery] || {};
      for(const machine of Object.keys(machinesObj)){
        const cats = machinesObj[machine] || {};
        for(const catKey of Object.keys(cats)){
          const folderId = cats[catKey]; if(folderId){ out.push({ bakery, machine, cat:catKey, folderId }); }
        }
      }
    }
    return out;
  }
  const FOLDER_INDEX = buildFolderIndex();
  function escapeQueryForDrive(name){ return (name||'').replace(/'/g, "\\'"); }

  async function searchFolderPublic(folderId, query){
    const q = `'${folderId}' in parents and trashed=false and name contains '${escapeQueryForDrive(query)}'`;
    const params = new URLSearchParams({ q, fields:'files(id,name,modifiedTime,mimeType,webViewLink,parents)', orderBy:'modifiedTime desc', pageSize:'50', key:API_KEY, supportsAllDrives:'true', includeItemsFromAllDrives:'true' });
    const res = await fetch('https://www.googleapis.com/drive/v3/files?'+params.toString());
    if(!res.ok){ const j=await res.json().catch(()=>({})); throw new Error(j.error?.message||('HTTP '+res.status)); }
    const data = await res.json(); return data.files || [];
  }
  async function searchFolderPrivate(folderId, query){
    const q = `'${folderId}' in parents and trashed=false and name contains '${escapeQueryForDrive(query)}'`;
    const res = await gapi.client.drive.files.list({ q, fields:'files(id,name,modifiedTime,mimeType,webViewLink,parents)', orderBy:'modifiedTime desc', pageSize:50, supportsAllDrives:true, includeItemsFromAllDrives:true });
    return res.result.files || [];
  }

  function renderSearchResultsHeader(query){
    const view=document.getElementById('view'); view.innerHTML='';
    const card=document.createElement('div'); card.className='card';
    const h=document.createElement('h3'); h.textContent=`Search results for “${query}”`; card.appendChild(h);
    const small=document.createElement('div'); small.className='small'; small.textContent = isAdminSignedIn() ? 'Searching all mapped Drive folders (admin mode)…' : 'Searching public files in all mapped Drive folders…'; card.appendChild(small);
    const list=document.createElement('div'); list.className='list'; list.id='globalResults'; card.appendChild(list);
    view.appendChild(card);
  }

  function appendSearchItem(container, meta, f){
    const row=document.createElement('div'); row.className='item';
    const title=document.createElement('a'); title.className='title'; title.href='#'; title.onclick=(e)=>{ e.preventDefault(); openInlinePreview(f, isAdminSignedIn()); };
    const when=f.modifiedTime?new Date(f.modifiedTime).toLocaleString():'';
    const path = `${meta.bakery} › ${meta.machine} › ${CATS[meta.cat]?.title||meta.cat}`;
    title.innerHTML=`<div><strong>${escapeHtml(f.name)}</strong><div class="meta">${escapeHtml(path)} • ${escapeHtml(f.mimeType||'')} • ${escapeHtml(when)}</div></div>`;
    const dl=document.createElement('a'); dl.className='icon-btn'; dl.href = isAdminSignedIn() ? `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media` : `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media&key=${API_KEY}`; dl.target='_blank'; dl.rel='noopener';
    dl.innerHTML=`<svg viewBox="0 0 24 24" fill="none"><path d="M12 3v10m0 0 4-4m-4 4-4-4M4 20h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    row.append(title, dl); container.appendChild(row);
  }

  async function drawSearch(query){
    crumbsSet([{label:'Home',to:{}},{label:`Search: ${query}`,to:{q:query}}]);
    renderSearchResultsHeader(query);
    const list = document.getElementById('globalResults');
    list.innerHTML = '<div class="small">Scanning mapped folders…</div>';
    const concurrency = 6; let idx = 0, resultsCount = 0; list.innerHTML = '';

    async function worker(){
      while(idx < FOLDER_INDEX.length){
        const i = idx++; const meta = FOLDER_INDEX[i];
        try{
          const files = isAdminSignedIn() ? await searchFolderPrivate(meta.folderId, query) : await searchFolderPublic(meta.folderId, query);
          files.forEach(f => { appendSearchItem(list, meta, f); resultsCount++; });
        }catch(e){ /* ignore per-folder errors */ }
      }
    }
    const workers = Array.from({length: Math.min(concurrency, FOLDER_INDEX.length)}, worker);
    await Promise.all(workers);
    if(resultsCount === 0){ list.innerHTML = '<div class="small">No results.</div>'; }
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

  /* ===== Router draw ===== */
  function draw(){
    const p=params();
    const b=p.get('bakery');
    const m=p.get('machine');
    const c=p.get('cat');
    const q=p.get('q');

    if(q){ drawSearch(q); return; }
    if(!b){ drawHome(); return; }
    if(b && !m){ drawBakery(b); return; }
    if(b && m && !c){ drawMachine(b,m); return; }
    if(b && m && c){ drawCategory(b,m,c); return; }
  }
  window.addEventListener('load', draw);

  /* ===== Global search form ===== */
  const gsForm = document.getElementById('globalSearchForm');
  const gsInput = document.getElementById('globalSearchInput');
  const clearBtn = document.getElementById('clearSearchBtn');
  if(gsForm){
    gsForm.addEventListener('submit', (e)=>{
      e.preventDefault(); const q = (gsInput.value||'').trim();
      if(q){ go({ q }); clearBtn.style.display=''; } else { go({}); clearBtn.style.display='none'; }
    });
  }
  if(clearBtn){ clearBtn.addEventListener('click', ()=>{ gsInput.value=''; go({}); clearBtn.style.display='none'; }); }

  /* ===== PIN gate ===== */
  const PIN_CODE = '2906';
  const lock = document.getElementById('lockscreen');
  const pinInput = document.getElementById('pinInput');
  const pinBtn = document.getElementById('pinBtn');
  const pinMsg = document.getElementById('pinMsg');
  function checkPin(){
    const val=(pinInput.value||'').trim();
    if(val === PIN_CODE){
      lock.style.display = 'none';
      sessionStorage.setItem('unlocked','1');
      pinMsg.style.display = 'none';
      pinInput.value='';
    } else {
      pinMsg.style.display = 'block';
      lock.animate([
        { transform:'translateX(0px)' },
        { transform:'translateX(-6px)' },
        { transform:'translateX(6px)' },
        { transform:'translateX(-4px)' },
        { transform:'translateX(4px)' },
        { transform:'translateX(0px)' }
      ], { duration: 250 });
      setTimeout(()=>pinMsg.style.display='none', 1800);
    }
  }
  pinBtn.addEventListener('click', checkPin);
  pinInput.addEventListener('keypress', e=>{ if(e.key === 'Enter') checkPin(); });
  if(sessionStorage.getItem('unlocked') === '1'){ lock.style.display = 'none'; }
  </script>
</body>
</html>
